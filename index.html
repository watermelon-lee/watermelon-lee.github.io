<!DOCTYPE html>


<script type="text/javascript"
color="0,0,255" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>





  


<html class="theme-next pisces use-motion" lang="zh-Hans">



<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Watermelon" />





  <link rel="alternate" href="/atom.xml" title="Watermelon" type="application/atom+xml" />






<meta name="description" content="this is us!">
<meta property="og:type" content="website">
<meta property="og:title" content="Watermelon">
<meta property="og:url" content="https://watermelon-lee.github.io/index.html">
<meta property="og:site_name" content="Watermelon">
<meta property="og:description" content="this is us!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Watermelon">
<meta name="twitter:description" content="this is us!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://watermelon-lee.github.io/"/>





  <title>Watermelon</title>
  








</head>



<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"><a href="https://github.com/watermelon-lee?tab=overview&from=2018-03-01&to=2018-03-31"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Watermelon</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">远远和元老大的小窝</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://watermelon-lee.github.io/2018/04/26/Spring-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="watermelon-lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watermelon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/26/Spring-cache/" itemprop="url">Spring-cache初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-26T10:45:37+08:00">
                2018-04-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/study/" itemprop="url" rel="index">
                    <span itemprop="name">study</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/26/Spring-cache/" class="leancloud_visitors" data-flag-title="Spring-cache初探">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"> ℃ </span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,768
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  12
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>可以讲缓存定义为一种存储机制,他将数据保存在某个地方,以一种更快的方式提供服务</p>
<h3 id="缓存命中率"><a href="#缓存命中率" class="headerlink" title="缓存命中率"></a>缓存命中率</h3><p>命中率=从缓存中读取的次数/(总读取次数{从缓存读取的次数+从慢速设备上读取的次数}),缓存策略一般命中率越高越好</p>
<h3 id="过期策略"><a href="#过期策略" class="headerlink" title="过期策略"></a>过期策略</h3><p>如果缓存满了,从缓存中移除数据的策略.常见的有LFU,LRU,FIFO  </p>
<ul>
<li>FIFO(first in first out):先进先出,先放入缓存的数据先移除</li>
<li>LRU(least recently used):最久未使用策略,即使用时间距离现在最久的那个数据被移除</li>
<li>LFU(least frequently used):最久最少使用策略,一定时间段内使用次数最少的那个数据被移除</li>
<li>TTL(time to live):存活期,即从缓存中创建时间点开始知道到期的一个时间点(不管在存活期内是否被访问过)</li>
<li>TTI(time ti idle):空闲期,数据多久没被访问就从缓存中移除</li>
</ul>
<h3 id="使用Spring-Cache"><a href="#使用Spring-Cache" class="headerlink" title="使用Spring Cache"></a>使用Spring Cache</h3><p>首先自己自定义一个缓存,然后在将其与Spring Cache对比.<br>假如我们需要查询用户,为了避免多次访问数据库,我们会对其做一个缓存,以userId为键,userValue为值.当查询相同的userId时,程序直接从缓存中获取结果,否则更新缓存.<br>实体类User定义:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.domain;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class User implements Serializable&#123;</span><br><span class="line">    private String userId;</span><br><span class="line">    private String userName;</span><br><span class="line">    private int age;</span><br><span class="line"></span><br><span class="line">    public User(String userId) &#123;</span><br><span class="line">        this.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserId() &#123;</span><br><span class="line">        return userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserId(String userId) &#123;</span><br><span class="line">        this.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getUserName() &#123;</span><br><span class="line">        return userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setUserName(String userName) &#123;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getAge() &#123;</span><br><span class="line">        return age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setAge(int age) &#123;</span><br><span class="line">        this.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>java缓存的对象与序列化是息息相关的,一般情况下,需要被缓存的实体类实现Serializable,只有实现了Serializable接口类,JVM才可以对其对象进行序列化.<br>接下来定义一个缓存管理器,负责实现缓存逻辑,支持对象的增加修改和删除,并支持泛型:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.mycache;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line">import java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line">public class CacheManager&lt;T&gt; &#123;</span><br><span class="line">    private Map&lt;String,T&gt; cache=new ConcurrentHashMap&lt;String, T&gt;();</span><br><span class="line"></span><br><span class="line">    public T getValue(Object key)&#123;</span><br><span class="line">        return cache.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addOrUpdateCache(String key,T value)&#123;</span><br><span class="line">        cache.put(key,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void evictCache(String key)&#123;//按键值清除缓存</span><br><span class="line">        cache.remove(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void evictCache()&#123;//清除所有缓存</span><br><span class="line">        cache.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在提供一个用户查询的服务类:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.mycache;</span><br><span class="line"></span><br><span class="line">import com.cache.domain.User;</span><br><span class="line"></span><br><span class="line">public class UserService &#123;</span><br><span class="line">    private CacheManager&lt;User&gt; cacheManager;</span><br><span class="line"></span><br><span class="line">    public UserService()&#123;</span><br><span class="line">        //构造一个缓存器</span><br><span class="line">        cacheManager=new CacheManager&lt;User&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public User getUserById(String userId)&#123;</span><br><span class="line">        //首先查询缓存</span><br><span class="line">        User result=cacheManager.getValue(userId);</span><br><span class="line">        if(result!=null)&#123;</span><br><span class="line">            System.out.println(&quot;get forum cache...&quot;+userId);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            result=getForumDb(userId);</span><br><span class="line">            if(result!=null)&#123;</span><br><span class="line">                //将数据查询结果更新到</span><br><span class="line">                cacheManager.addOrUpdateCache(userId,result);</span><br><span class="line">            &#125;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void reload()&#123;</span><br><span class="line">        cacheManager.evictCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private User getForumDb(String userId)&#123;</span><br><span class="line">        System.out.println(&quot;real querying db...&quot;+userId);</span><br><span class="line">        return new User(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编写一个测试类:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.mycache;</span><br><span class="line"></span><br><span class="line">import com.cache.domain.User;</span><br><span class="line">import com.cache.mycache.UserService;</span><br><span class="line"></span><br><span class="line">public class UserMain &#123;</span><br><span class="line">    public static void main(String[] a)&#123;</span><br><span class="line">        UserService userService=new UserService();</span><br><span class="line"></span><br><span class="line">        //开始查询账号</span><br><span class="line">        userService.getUserById(&quot;001&quot;);//第一次查询,从数据库查询</span><br><span class="line">        userService.getUserById(&quot;001&quot;);//第二次查询,从缓存返回</span><br><span class="line"></span><br><span class="line">        //重置缓存</span><br><span class="line">        userService.reload();</span><br><span class="line">        System.out.println(&quot;after reload&quot;);</span><br><span class="line"></span><br><span class="line">        userService.getUserById(&quot;001&quot;);//再次查询,从数据库返回</span><br><span class="line">        userService.getUserById(&quot;001&quot;);//缓存返回</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以得到结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">real querying db...001</span><br><span class="line">get forum cache...001</span><br><span class="line">after reload</span><br><span class="line">real querying db...001</span><br><span class="line">get forum cache...001</span><br></pre></td></tr></table></figure></p>
<p>可以看出缓存可以正常工作,但是这种方式十分不优雅,缓存代码与业务代码高度耦合,业务代码中包含了大量缓存逻辑控制代码,下面使用Spring Cache来改进上述代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.simpleCache;</span><br><span class="line">import com.cache.domain.User;</span><br><span class="line">import org.springframework.cache.annotation.Cacheable;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service(&quot;userServiceBean&quot;)</span><br><span class="line">public class UserServiceBySpringCache&#123;</span><br><span class="line"></span><br><span class="line">    //使用一个名为users的缓存</span><br><span class="line">    @Cacheable(cacheNames = &quot;users&quot;)</span><br><span class="line">    public User getUserById(String userId)&#123;</span><br><span class="line">        //方法内部不考虑缓存逻辑,直接实现</span><br><span class="line">        System.out.println(&quot;执行用户业务方法查找&quot;+userId);</span><br><span class="line">        return getForumDb(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private User getForumDb(String userId)&#123;</span><br><span class="line">        System.out.println(&quot;从数据库中查找&quot;+userId);</span><br><span class="line">        return new User(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>getUserById()方法标注了一个注解@Cacheable(cacheNames=”users”),当调用这个方法的时候,会先从缓存中匹配对象,如果存在,直接返回,如果不存在,则执行方法体内的逻辑,并且将返回值放入缓存中.对应缓存的key是userId,value就是userId对应的User对象.<br>在配置文件中配置支持注解缓存:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:cache=&quot;http://www.springframework.org/schema/cache&quot;</span><br><span class="line">       xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;cache:annotation-driven/&gt;</span><br><span class="line">    &lt;context:component-scan base-package=&quot;com.cache.simpleCache&quot;/&gt;</span><br><span class="line">    &lt;!--&lt;bean id=&quot;cacheService&quot; class=&quot;com.cache.simpleCache.UserServiceBySpringCache&quot;/&gt;--&gt;</span><br><span class="line">    &lt;bean id=&quot;cacheManager&quot; class=&quot;org.springframework.cache.support.SimpleCacheManager&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;caches&quot;&gt;</span><br><span class="line">            &lt;set&gt;</span><br><span class="line">                &lt;bean class=&quot;org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean&quot; p:name=&quot;default&quot;/&gt;</span><br><span class="line">                &lt;bean class=&quot;org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean&quot; p:name=&quot;users&quot;/&gt;</span><br><span class="line">            &lt;/set&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>Spring通过<a href="cache:annotation-driven/" target="_blank" rel="noopener">cache:annotation-driven/</a>就可以启动基于注解的缓存驱动,这个配置项默认了使用了一个名为cacheManager的缓存管理器.SimpleCacheManager是这个缓存管理器的默认实现,他通过对其属性caches的配置来实现刚刚自定义的缓存管理器逻辑.除了默认default缓存外,还自定义了一个名为users的缓存,使用了默认的内存存储方案concurrentMapCacheFactoryBean.接下来重写测试类,以观察结果:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.simpleCache;</span><br><span class="line"></span><br><span class="line">import org.springframework.context.ApplicationContext;</span><br><span class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line">public class UserCacheMain &#123;</span><br><span class="line">    public static void main(String[] a)&#123;</span><br><span class="line">        ApplicationContext context=new ClassPathXmlApplicationContext(&quot;applicationContext.xml&quot;);</span><br><span class="line">        UserServiceBySpringCache userService=(UserServiceBySpringCache)context.getBean(&quot;userServiceBean&quot;);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;first query&quot;);</span><br><span class="line">        userService.getUserById(&quot;me&quot;);</span><br><span class="line">        System.out.println(&quot;second query&quot;);</span><br><span class="line">        userService.getUserById(&quot;me&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结果为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">first query</span><br><span class="line">执行用户业务方法查找me</span><br><span class="line">从数据库中查找me</span><br><span class="line">second query</span><br></pre></td></tr></table></figure></p>
<p>可以看出使用Spring cache成功,我们仅仅在userServiceBySpringCache中的Service上注解了一个@Cacheable就实现了基本缓存方案.使用Spring Cache十分简单,只需要两个步骤:</p>
<ul>
<li>缓存定义:确定需要缓存的方法和缓存策略</li>
<li>配置缓存:配置缓存</li>
</ul>
<p>##　Spring Cache抽象</p>
<h3 id="注解缓存"><a href="#注解缓存" class="headerlink" title="注解缓存"></a>注解缓存</h3><h4 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h4><p>@Cacheable是最重要的注解,它指定了返回值是可以被缓存的.缓存名是必须提供的,可用引号,Value或者cacheNames属性来定义.此外还可以定义多个缓存,在该类表中使用逗号分隔缓存名,并且用花括号括起来.例如:<code>@Cacheable(cacheNames={&quot;cache1&quot;,&quot;cache2&quot;}</code>  </p>
<h5 id="键生成器"><a href="#键生成器" class="headerlink" title="键生成器"></a>键生成器</h5><p>缓存的本质就是键值对集合.Spring提供了默认的SimpleKeyGenerator,使用一个符合键SimpleKey.规则为:  </p>
<ul>
<li>如果方法没有入参,使用SimpleKey.EMPTY为key</li>
<li>如果方法只有一个入参,则使用该入参作为key</li>
<li>如果方法有多个入参,则返回包含所有入参的一个SimpleKey<br>此外可以使用SpEL来指定自定义键,如:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Cacheable(cacheNames=&quot;users&quot; key=&quot;#user.getCode&quot;)</span><br><span class="line">public User GetUser(User user,boolean checkLogout)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>上述函数有一个checkLogout用于区分用户是都注销,而我们不想使用其作为key的一部分,可以根据key属性指定为userCode.</p>
<h5 id="带条件的缓存"><a href="#带条件的缓存" class="headerlink" title="带条件的缓存"></a>带条件的缓存</h5><p>使用@Cacheable注解的Condition属性可以按条件来缓存.condition属性使用了SpEL表达式动态评估方法入参是否满足条件.<br>例如使用了@Cacheable声明的方法getUser(),我们启用一个条件:仅仅对年龄小于35的用户缓存<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class UserService &#123;</span><br><span class="line">    private Map&lt;Integer, User&gt; users = new HashMap&lt;Integer, User&gt;();</span><br><span class="line">    &#123;</span><br><span class="line">        users.put(1, new User(&quot;1&quot;, &quot;w1&quot;,37));</span><br><span class="line">        users.put(2, new User(&quot;2&quot;, &quot;w2&quot;, 34));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Cacheable(value = &quot;users&quot;, condition = &quot;#user.age &lt; 35&quot;)</span><br><span class="line">    public User getUser(User user) &#123;</span><br><span class="line">        System.out.println(&quot;User with id &quot; + user.getUserId() + &quot; requested.&quot;);</span><br><span class="line">        return users.get(Integer.valueOf(user.getUserId()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h4><p>@CachePut与@Cacheable效果几乎一样,他首先执行方法,然后将返回值放入缓存.当希望更新数据,以方法返回值来更新缓存就可以使用该注解.@CachePut注解会强制执行方法而更新缓存,而@Cacheable会直接跳过方法从直接获取缓存,所以两者不可以同时使用.如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@CachePut(cacheNames=&quot;book&quot;, key=&quot;#isbn&quot;)</span><br><span class="line">public Book updateBook(ISBN isbn, BookDescriptor descriptor)</span><br></pre></td></tr></table></figure></p>
<p>在更新操作后,缓存中的book对应的BookDescriptor为更新之后的值.</p>
<h4 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h4><p>@CacheEvict是@Cacheable的反向操作,负责从缓存中删除一个数据.@CacheEvict要求指定一个或多个缓存，使之都受影响。如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@CacheEvict(cacheNames=&quot;users&quot;)</span><br><span class="line">public void removeUser(int id)&#123;</span><br><span class="line">    usersremove(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用@CacheEvict即可从缓存中删除一个用户.同样的,@CacheEvict也提供了Condition和key属性.此外，还提供了两个额外的参数allEntries和beforeInvocation。allEntries表示是否需要清除缓存中的所有元素。默认为false，表示不需要。当指定了allEntries为true时，Spring Cache将忽略指定的key。而beforeInvocation可以改变清除操作的时间.平时都是方法执行完毕后清除缓存,如果方法抛出异常,则不会清除缓存.而指定beforeInvocation为true,则会在方法调用前清除缓存.</p>
<h4 id="Caching"><a href="#Caching" class="headerlink" title="@Caching"></a>@Caching</h4><p>@Caching是一个组注解,可以为一个方法定义提供基于@Cacheable,@CacheEvict,@CachePut的数组.假设我们定义了一个User,Member,Visitor三个实体类,User为抽象类,而member和Visitor为继承他的子类.<br>我们可以使用@Caching声明两个@Cacheable注解,使其指向不同的两个缓存:member和Visitor.然后根据两个@Cacheable注解定义的条件对方法中的参数进行检查,将对象存储在对应的缓存.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.cache.caching;</span><br><span class="line"></span><br><span class="line">import com.cache.domain.User;</span><br><span class="line">import org.springframework.cache.annotation.Cacheable;</span><br><span class="line">import org.springframework.cache.annotation.Caching;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Service(value = &quot;cacheGroupUserService&quot;)</span><br><span class="line">public class UserService &#123;</span><br><span class="line">    private Map&lt;Integer,User&gt; map=new HashMap&lt;Integer, User&gt;();</span><br><span class="line">    &#123;</span><br><span class="line">        map.put(1,new Member(&quot;1&quot;,&quot;member1&quot;));</span><br><span class="line">        map.put(2,new Visitor(&quot;2&quot;,&quot;visitor1&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Caching(cacheable = &#123;</span><br><span class="line">            @Cacheable(value = &quot;members&quot;,condition = &quot;#obj instanceof T(com.domain.Mamber)&quot;),</span><br><span class="line">            @Cacheable(value = &quot;visitor&quot;,condition = &quot;#obj instanceof T(com.domain.Visitor)&quot;),</span><br><span class="line">    &#125;)</span><br><span class="line">    public User getUser(User obj)&#123;</span><br><span class="line">        return map.get(Integer.valueOf(obj.getUserId()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="CacheConfig"><a href="#CacheConfig" class="headerlink" title="@CacheConfig"></a>@CacheConfig</h4><p>前面的注解都是基于方法的,假如我们在一个类中需要的缓存的方法注解属性一致,则需要一个个重复的添加.我们可以使用@CacheConfig来配置.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@CacheConfig(cacheNames=&quot;users&quot;,keyGenerator=&quot;MyKeyGenerator&quot;)</span><br><span class="line">public class UserService&#123;</span><br><span class="line">    @Cacheable</span><br><span class="line">    public User findA(User user)&#123;</span><br><span class="line">    ....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Cacheable</span><br><span class="line">    public User findB(User user)&#123;</span><br><span class="line">    ....</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    <div>
  	
    </div>

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://watermelon-lee.github.io/2018/04/21/Spring-ORM/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="watermelon-lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watermelon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/21/Spring-ORM/" itemprop="url">Spring-ORM框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-21T22:32:28+08:00">
                2018-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/study/" itemprop="url" rel="index">
                    <span itemprop="name">study</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/21/Spring-ORM/" class="leancloud_visitors" data-flag-title="Spring-ORM框架">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"> ℃ </span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,515
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>非常简单学习了一下Hibernate与Mybatis,两者给我的感受是Hibernate对于初学者上手很快,不需要自己写Sql语句,相比于Mybatis对于每一个实体类需要一个映射文件来说,它的使用十分快捷方便.但是在使用过程中出现的问题也更多,Hql语句定义问题啊,使用泛型BaseDao问题什么,自己对于Hibernate也完全不了解,出了Bug需要查阅许多博客.而使用Mybatis可以不用自己写Dao实现类,可以使用Mybatis的提供的MapperScannerConfigurer直接将映射接口转换为Spring容器的Bean.</p>
<h1 id="使用Hibernate"><a href="#使用Hibernate" class="headerlink" title="使用Hibernate"></a>使用Hibernate</h1><h2 id="使用注解配置"><a href="#使用注解配置" class="headerlink" title="使用注解配置"></a>使用注解配置</h2><p>使用配置注解的话就可以不用编写Hibernate映射文件,我认为注解更为便捷<br>配置文件如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE hibernate-mapping PUBLIC &quot;-//Hibernate/Hibernate Mapping DTD//EN&quot;</span><br><span class="line">		&quot;http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd&quot;&gt;</span><br><span class="line">&lt;hibernate-mapping auto-import=&quot;true&quot; default-lazy=&quot;false&quot;&gt;</span><br><span class="line">	&lt;class name=&quot;com.smart.domain.Forum&quot; table=&quot;t_forum&quot;&gt;</span><br><span class="line">		&lt;id name=&quot;forumId&quot; column=&quot;forum_id&quot;&gt;</span><br><span class="line">			&lt;generator class=&quot;assigned&quot; /&gt;</span><br><span class="line">		&lt;/id&gt;</span><br><span class="line">		&lt;property name=&quot;forumName&quot; column=&quot;forum_name&quot; /&gt;</span><br><span class="line">		&lt;property name=&quot;forumDesc&quot; column=&quot;forum_desc&quot; /&gt;</span><br><span class="line">	&lt;/class&gt;</span><br><span class="line">&lt;/hibernate-mapping&gt;</span><br></pre></td></tr></table></figure></p>
<p>该Forum实体类的映射文件等价于下面注解.<br>对Forum和Post两个实体类标记注解:<br>Forum:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">:@Entity</span><br><span class="line">@Table(name=&quot;t_forum&quot;)</span><br><span class="line">public class Forum implements Serializable&#123;</span><br><span class="line">	@Id</span><br><span class="line">	@Column(name = &quot;forum_id&quot;, nullable = true)</span><br><span class="line">	private int forumId;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;forum_name&quot; ,nullable = true)</span><br><span class="line">	private String forumName;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;forum_desc&quot; ,nullable = true)</span><br><span class="line">	private String forumDesc;</span><br><span class="line">	</span><br><span class="line">	public String getForumDesc() &#123;</span><br><span class="line">		return forumDesc;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setForumDesc(String forumDesc) &#123;</span><br><span class="line">		this.forumDesc = forumDesc;</span><br><span class="line">	&#125;</span><br><span class="line">	public int getForumId() &#123;</span><br><span class="line">		return forumId;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setForumId(int forumId) &#123;</span><br><span class="line">		this.forumId = forumId;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getForumName() &#123;</span><br><span class="line">		return forumName;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setForumName(String forumName) &#123;</span><br><span class="line">		this.forumName = forumName;</span><br><span class="line">	&#125;</span><br><span class="line">	public String toString()&#123;</span><br><span class="line">		return ToStringBuilder.reflectionToString(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Post:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">@Entity</span><br><span class="line">@Table(name=&quot;t_post&quot;)</span><br><span class="line">public class Post implements Serializable &#123;</span><br><span class="line">	@Id</span><br><span class="line">	@Column(name = &quot;post_id&quot;)</span><br><span class="line">	private int postId;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;user_id&quot;)</span><br><span class="line">	private int userId;</span><br><span class="line">	</span><br><span class="line">	@ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;topic_id&quot;)</span><br><span class="line">	private Topic topic;</span><br><span class="line">	</span><br><span class="line">	@Lob</span><br><span class="line">	@Basic(fetch = FetchType.LAZY)</span><br><span class="line">	@Column(name = &quot;post_text&quot;,columnDefinition = &quot;CLOB&quot;)</span><br><span class="line">	//@Type(type=&quot;org.springframework.orm.hibernate4.support.ClobStringType&quot;)</span><br><span class="line">	private String postText;</span><br><span class="line">	</span><br><span class="line">	@Lob</span><br><span class="line">	@Basic(fetch = FetchType.LAZY)</span><br><span class="line">	@Column(name = &quot;post_attach&quot;,columnDefinition = &quot;BLOB&quot;)</span><br><span class="line">	//@Type(type=&quot;org.springframework.orm.hibernate4.support.BlobByteArrayType&quot;)</span><br><span class="line">	private byte[] postAttach;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;post_time&quot;)</span><br><span class="line">	private Date postTime;</span><br><span class="line">	</span><br><span class="line">	public int getPostId() &#123;</span><br><span class="line">		return postId;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setPostId(int postId) &#123;</span><br><span class="line">		this.postId = postId;</span><br><span class="line">	&#125;</span><br><span class="line">	public String getPostText() &#123;</span><br><span class="line">		return postText;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setPostText(String postText) &#123;</span><br><span class="line">		this.postText = postText;</span><br><span class="line">	&#125;</span><br><span class="line">	public Date getPostTime() &#123;</span><br><span class="line">		return postTime;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setPostTime(Date postTime) &#123;</span><br><span class="line">		this.postTime = postTime;</span><br><span class="line">	&#125;</span><br><span class="line">	public int getUserId() &#123;</span><br><span class="line">		return userId;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setUserId(int userId) &#123;</span><br><span class="line">		this.userId = userId;</span><br><span class="line">	&#125;</span><br><span class="line">	public byte[] getPostAttach() &#123;</span><br><span class="line">		return postAttach;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setPostAttach(byte[] postAttach) &#123;</span><br><span class="line">		this.postAttach = postAttach;</span><br><span class="line">	&#125;</span><br><span class="line">	public Topic getTopic() &#123;</span><br><span class="line">		return topic;</span><br><span class="line">	&#125;</span><br><span class="line">	public void setTopic(Topic topic) &#123;</span><br><span class="line">		this.topic = topic;</span><br><span class="line">	&#125;</span><br><span class="line">	public String toString()&#123;</span><br><span class="line">		return ToStringBuilder.reflectionToString(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Topic:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">package com.domain;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.builder.ToStringBuilder;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Entity</span><br><span class="line">@Table(name=&quot;t_topic&quot;)</span><br><span class="line">public class Topic implements Serializable &#123;</span><br><span class="line">	private static final long serialVersionUID = 1L; </span><br><span class="line">	@Id</span><br><span class="line">	@Column(name = &quot;topic_id&quot;)</span><br><span class="line">	private int topicId;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;user_id&quot;)</span><br><span class="line">	private int userId;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;topic_title&quot;)</span><br><span class="line">	private String topicTitle;</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;topic_time&quot;)</span><br><span class="line">	private Date topicTime;</span><br><span class="line">	</span><br><span class="line">	@ManyToOne</span><br><span class="line">    @JoinColumn(name = &quot;forum_id&quot;)</span><br><span class="line">	private Forum forum;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	@Column(name = &quot;topic_views&quot;)</span><br><span class="line">	private int topicViews;</span><br><span class="line">	</span><br><span class="line">	@OneToMany(mappedBy = &quot;topic&quot;, cascade = CascadeType.ALL)</span><br><span class="line">	private List&lt;Post&gt; posts;</span><br><span class="line"></span><br><span class="line">	@Column(name = &quot;topic_replies&quot;)</span><br><span class="line">    private int topicReplies;</span><br><span class="line">	</span><br><span class="line">	public int getTopicId() &#123;</span><br><span class="line">		return topicId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setTopicId(int topicId) &#123;</span><br><span class="line">		this.topicId = topicId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Date getTopicTime() &#123;</span><br><span class="line">		return topicTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setTopicTime(Date topicTime) &#123;</span><br><span class="line">		this.topicTime = topicTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public String getTopicTitle() &#123;</span><br><span class="line">		return topicTitle;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setTopicTitle(String topicTitle) &#123;</span><br><span class="line">		this.topicTitle = topicTitle;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public int getTopicViews() &#123;</span><br><span class="line">		return topicViews;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setTopicViews(int topicViews) &#123;</span><br><span class="line">		this.topicViews = topicViews;</span><br><span class="line">	&#125;</span><br><span class="line">	public String toString()&#123;</span><br><span class="line">		return ToStringBuilder.reflectionToString(this);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Forum getForum() &#123;</span><br><span class="line">		return forum;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setForum(Forum forum) &#123;</span><br><span class="line">		this.forum = forum;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public int getUserId() &#123;</span><br><span class="line">		return userId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setUserId(int userId) &#123;</span><br><span class="line">		this.userId = userId;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public List&lt;Post&gt; getPosts() &#123;</span><br><span class="line">		return posts;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setPosts(List&lt;Post&gt; posts) &#123;</span><br><span class="line">		this.posts = posts;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public int getTopicReplies() &#123;</span><br><span class="line">		return topicReplies;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void setTopicReplies(int topicReplies) &#123;</span><br><span class="line">		this.topicReplies = topicReplies;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后XML配置文件中使用packagesToScan来让Spring扫描加载带注释的实体类,可以使用逗号分隔,制定一系列的包名:<code>&lt;property name=&quot;packagesToScan&quot; value=&quot;com.domain&quot;/&gt;</code></p>
<h2 id="配置SessionFactory"><a href="#配置SessionFactory" class="headerlink" title="配置SessionFactory"></a>配置SessionFactory</h2><p>配置文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--制定Hibernate实体类映射,以及制定Hibernate配置属性--&gt;</span><br><span class="line">   &lt;bean id=&quot;sessionFactory&quot; class=&quot;org.springframework.orm.hibernate4.LocalSessionFactoryBean&quot; p:dataSource-ref=&quot;dataSource&quot; &gt;</span><br><span class="line">       &lt;property name=&quot;packagesToScan&quot; value=&quot;com.domain&quot;/&gt;</span><br><span class="line">       &lt;property name=&quot;hibernateProperties&quot;&gt;</span><br><span class="line">           &lt;props&gt;</span><br><span class="line">               &lt;prop key=&quot;hibernate.dialect&quot;&gt;</span><br><span class="line">                   org.hibernate.dialect.MySQLDialect</span><br><span class="line">               &lt;/prop&gt;</span><br><span class="line">               &lt;prop key=&quot;hibernate.show_sql&quot;&gt;</span><br><span class="line">                   true</span><br><span class="line">               &lt;/prop&gt;</span><br><span class="line">           &lt;/props&gt;</span><br><span class="line">       &lt;/property&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用HibernateTemplate"><a href="#使用HibernateTemplate" class="headerlink" title="使用HibernateTemplate"></a>使用HibernateTemplate</h2><p>基于模板类使用Hibernate是最简单的方式,按照Spring的风格,它提供了模板的支持类HibernateDaoSupport,并且通过getHibernateTemplate()方法像子类开放模板类实例的调用.配置如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;hibernateTemplate&quot;</span><br><span class="line">          class=&quot;org.springframework.orm.hibernate4.HibernateTemplate&quot;</span><br><span class="line">          p:sessionFactory-ref=&quot;sessionFactory&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>在实际开发中,开发者一般会在Spring支持类的基础上编写自己的Dao基类,进行自己的封装,以获得泛型的支持,并提供自己的代理方法.Dao基类并不需要对模板类的所有方法进行代理,只需代理一些常用的方法(如CRUD),不常用的方法可在子模板类中实现.<br>一般实体类对应的Dao都必须有自己的CRUD操作,与其在每个实体Dao接口中重复定义这些方法,不如提供一个通用的Dao接口.<br>BaseDao:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line">import com.domain.Forum;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.orm.hibernate4.HibernateTemplate;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line">import java.lang.reflect.ParameterizedType;</span><br><span class="line">import java.lang.reflect.Type;</span><br><span class="line"></span><br><span class="line">public class BaseDao&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    private HibernateTemplate hibernateTemplate;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public void setHibernateTemplate(HibernateTemplate hibernateTemplate) &#123;</span><br><span class="line">        this.hibernateTemplate = hibernateTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    private Class entityClass;</span><br><span class="line"></span><br><span class="line">    public BaseDao()&#123;</span><br><span class="line">//        Type genType = getClass().getGenericSuperclass();</span><br><span class="line">//        Type[] params = ((ParameterizedType) genType).getActualTypeArguments();</span><br><span class="line">//        entityClass = (Class) params[0];</span><br><span class="line"></span><br><span class="line">        //返回表示此 Class 所表示的实体类的 直接父类 的 Type。注意，是直接父类</span><br><span class="line">        //这里type结果是 com.dfsj.generic.GetInstanceUtil&lt;com.dfsj.generic.User&gt;</span><br><span class="line">            Type type = getClass().getGenericSuperclass();</span><br><span class="line">        // 判断 是否泛型</span><br><span class="line">            if( type instanceof ParameterizedType )&#123;</span><br><span class="line">                //getActualTypeArguments()返回表示此类型实际类型参数的Type对象的数组,这里我们只有一个泛型类.</span><br><span class="line">                // 当有多个泛型类时，数组的长度就不是1了</span><br><span class="line">                ParameterizedType pType = (ParameterizedType)type;</span><br><span class="line">                Type claz =  ((ParameterizedType) type).getActualTypeArguments()[0];</span><br><span class="line">                if( claz instanceof Class )&#123;</span><br><span class="line">                    this.entityClass = (Class&lt;T&gt;) claz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public T get(int id)&#123;</span><br><span class="line">        return (T)hibernateTemplate.get(entityClass, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void save(T entity)&#123;</span><br><span class="line">        hibernateTemplate.save(entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void update(T entity)&#123;</span><br><span class="line">        hibernateTemplate.update(entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public HibernateTemplate getHibernateTemplate() &#123;</span><br><span class="line">        return hibernateTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ForumHibernateDao:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.HibrenateDao;</span><br><span class="line"></span><br><span class="line">import com.BaseDao;</span><br><span class="line">import com.domain.Forum;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.orm.hibernate4.HibernateTemplate;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.ParameterizedType;</span><br><span class="line">import java.lang.reflect.Type;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public class ForumHibernateDao extends BaseDao&lt;Forum&gt; &#123;//使用HQL查询</span><br><span class="line">    private HibernateTemplate hibernateTemplate;</span><br><span class="line"></span><br><span class="line">    public long getForumNum()&#123;</span><br><span class="line">        Object object=getHibernateTemplate().iterate(&quot;select count(forum.forumId) from Forum  forum&quot;).next();</span><br><span class="line">        return (Long)object;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Forum&gt; findForumByName(String forumName) &#123;</span><br><span class="line">        return (List&lt;Forum&gt;) getHibernateTemplate().find(</span><br><span class="line">                &quot;from Forum f where f.forumName like ?&quot;, forumName + &quot;%&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PostHibernateDao:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.HibrenateDao;</span><br><span class="line"></span><br><span class="line">import com.BaseDao;</span><br><span class="line">import com.domain.Forum;</span><br><span class="line">import com.domain.Post;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public class PostHibernateDao extends BaseDao&lt;Post&gt; &#123;</span><br><span class="line">	</span><br><span class="line">	public void addPost(Post post) &#123;</span><br><span class="line">		getHibernateTemplate().save(post);	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public Post getPost(int postId) &#123;</span><br><span class="line">		// TODO Auto-generated method stub</span><br><span class="line">		return null;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在PostHibernateDao中addPost()中包含了Lob数据处理,需要在配置文件中定义LobHandler的Bean:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;lobHandler&quot; class=&quot;org.springframework.jdbc.support.lob.DefaultLobHandler&quot;</span><br><span class="line">          lazy-init=&quot;true&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>TopicHibernateDao:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.HibrenateDao;</span><br><span class="line"></span><br><span class="line">import com.BaseDao;</span><br><span class="line">import com.domain.Topic;</span><br><span class="line">import org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Repository</span><br><span class="line">public class TopicHibernateDao extends BaseDao&lt;Topic&gt; &#123;</span><br><span class="line">	public void addTopic(Topic topic) &#123;</span><br><span class="line">		getHibernateTemplate().save(topic);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	public Topic getTopicById(int topicId)&#123;</span><br><span class="line">		return getHibernateTemplate().get(Topic.class, topicId);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="事务处理"><a href="#事务处理" class="headerlink" title="事务处理"></a>事务处理</h3><p>Spring的通用事务处理对于Hibernate完全通用,代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">@Service(&quot;forumService&quot;)</span><br><span class="line">public class ForumHibernateService &#123;</span><br><span class="line">    private ForumHibernateDao forumHibernateDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private PostHibernateDao postHibernateDao;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    public void setForumHibernateDao(ForumHibernateDao forumHibernateDao) &#123;</span><br><span class="line">        this.forumHibernateDao = forumHibernateDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void addForum(Forum forum)&#123;</span><br><span class="line">        forumHibernateDao.save(forum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void updateForum(Forum forum)&#123;</span><br><span class="line">        forumHibernateDao.update(forum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public Forum getForum(int id)&#123;</span><br><span class="line">        return (Forum)forumHibernateDao.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public long getForumNum()&#123;</span><br><span class="line">       return forumHibernateDao.getForumNum();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Forum&gt; findForumByName(String name)&#123;</span><br><span class="line">        return forumHibernateDao.findForumByName(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addPost(Post post)&#123;</span><br><span class="line">        postHibernateDao.addPost(post);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在配置文件需要如下声明:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--事务处理--&gt;</span><br><span class="line">    &lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.hibernate4.HibernateTransactionManager&quot;</span><br><span class="line">          p:sessionFactory-ref=&quot;sessionFactory&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:annotation-driven/&gt;</span><br></pre></td></tr></table></figure></p>
<p>测试类编写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public class HibernateTest  &#123;</span><br><span class="line">    ApplicationContext context=new ClassPathXmlApplicationContext(&quot;com/Hibernate/Hibernate.xml&quot;);</span><br><span class="line">    ForumHibernateService service=(ForumHibernateService)context.getBean(&quot;forumService&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void test()&#123;</span><br><span class="line">        Forum forum=new Forum();</span><br><span class="line">        forum.setForumId(54);</span><br><span class="line">        forum.setForumName(&quot;watermelon&quot;);</span><br><span class="line">        forum.setForumDesc(&quot;my cute wife&quot;);</span><br><span class="line"></span><br><span class="line">        service.addForum(forum);</span><br><span class="line">        Forum forum2=service.getForum(11);</span><br><span class="line">        System.out.println(forum2);</span><br><span class="line">        long num=service.getForumNum();</span><br><span class="line">        forum.setForumDesc(&quot;my beautiful wife&quot;);</span><br><span class="line">        service.updateForum(forum);</span><br><span class="line"></span><br><span class="line">        List&lt;Forum&gt;forums=new ArrayList&lt;Forum&gt;();</span><br><span class="line">        forums=service.findForumByName(&quot;watermlon&quot;);</span><br><span class="line">        System.out.println(forums);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testAddPost() throws Throwable&#123;</span><br><span class="line"></span><br><span class="line">        Topic topic = new Topic();</span><br><span class="line">        topic.setTopicId(2);</span><br><span class="line">        Post post = new Post();</span><br><span class="line">        post.setPostId(17);</span><br><span class="line">        post.setPostText(&quot;post text...&quot;);</span><br><span class="line"></span><br><span class="line">        Resource resource = new ClassPathResource(&quot;temp.jpg&quot;);</span><br><span class="line">        byte[] imgFile = FileCopyUtils.copyToByteArray(resource.getFile());</span><br><span class="line">        post.setPostAttach(imgFile);</span><br><span class="line">        post.setTopic(topic);</span><br><span class="line">        service.addPost(post);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过测试类便可发现已经在数据库中完成了以上操作.</p>
<h1 id="使用Mybatis"><a href="#使用Mybatis" class="headerlink" title="使用Mybatis"></a>使用Mybatis</h1><h2 id="配置SQLMapClient"><a href="#配置SQLMapClient" class="headerlink" title="配置SQLMapClient"></a>配置SQLMapClient</h2><p>每个Mybatis应用程序都以一个SqlSessionFactory对象的实例为核心.Mybatis同样也需要构建对个SQL映射文件,并通过一个配置文件对这些映射文件来进行装配,同时在该装配文件中进行控制属性的信息.<br>下面是一个简单的Mybatis配置文件:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;settings&gt;</span><br><span class="line">        &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;false&quot;/&gt;</span><br><span class="line">    &lt;/settings&gt;</span><br><span class="line">    &lt;typeAliases&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Forum&quot; type=&quot;com.domain.Forum&quot;/&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Topic&quot; type=&quot;com.domain.Topic&quot;/&gt;</span><br><span class="line">        &lt;typeAlias alias=&quot;Post&quot; type=&quot;com.domain.Post&quot;/&gt;</span><br><span class="line">    &lt;/typeAliases&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure></p>
<p>上述定义了Mybatis框架运行行为的属性信息,typeAlias为全限定类的别名,在映射文件中可以通过别名代替具体的类名,简化配置.<br>映射文件如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span><br><span class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace=&quot;com.MybatisDao.ForumMybatisDao&quot;&gt;</span><br><span class="line">    &lt;select id=&quot;get&quot; resultType=&quot;Forum&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">        SELECT</span><br><span class="line">        forum_id forumId,</span><br><span class="line">        forum_name forumName,</span><br><span class="line">        forum_desc forumDesc</span><br><span class="line">        FROM t_forum</span><br><span class="line">        WHERE forum_id = #&#123;forumId&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select id=&quot;getNum&quot; resultType=&quot;int&quot;&gt;</span><br><span class="line">        SELECT COUNT(forum_id) FROM t_forum f</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select id=&quot;findForumByName&quot; resultType=&quot;Forum&quot; parameterType=&quot;string&quot;&gt;</span><br><span class="line">        SELECT</span><br><span class="line">        forum_id forumId,</span><br><span class="line">        forum_name forumName,</span><br><span class="line">        forum_desc forumDesc</span><br><span class="line">        FROM t_forum f</span><br><span class="line">        WHERE f.forum_name LIKE #&#123;forumName&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;insert id=&quot;save&quot; parameterType=&quot;Forum&quot;&gt;</span><br><span class="line">        INSERT INTO t_forum(forum_id,forum_name,forum_desc)</span><br><span class="line">        VALUES(#&#123;forumId&#125;,#&#123;forumName&#125;, #&#123;forumDesc&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">    &lt;update id=&quot;update&quot; parameterType=&quot;Forum&quot;&gt;</span><br><span class="line">        UPDATE t_forum f</span><br><span class="line">        SET forum_name=#&#123;forumName&#125;,forum_desc=#&#123;forumDesc&#125;</span><br><span class="line">        WHERE f.forum_id = #&#123;forumId&#125;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">    &lt;delete id=&quot;delete&quot; parameterType=&quot;int&quot;&gt;</span><br><span class="line">        DELETE FROM t_forum</span><br><span class="line">        WHERE forum_id=#&#123;forumIf&#125;</span><br><span class="line">    &lt;/delete&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure></p>
<p>该映射文件定义了对Forum实体类进行数据库操作是所需要的SQL语句,同时还定义了查询结果和对象属性的映射关系.namespace指定了映射所在的命名空间,每个具体的映射项都有一个id,可以通过命名空间和映射项的id定位到具体的映射项.映射项的parameterType指定传入参数对象,可以使全名限定类,也可以是类的别名,类的别名定义在Mybatis的配置文件中的typeAlias.如果映射项的参数是String等基本类型,可以使用int,long,string等基础类名.返回类型通过resultType指定,在映射项中通过#{xxx}绑定parameterType指定的参数类的属性,支持级联属性,如#{topic.forumId}.</p>
<h2 id="在Spring中配置Mybatis"><a href="#在Spring中配置Mybatis" class="headerlink" title="在Spring中配置Mybatis"></a>在Spring中配置Mybatis</h2><p>在其中可以使用mapperLocations指定配置文件.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;context:component-scan base-package=&quot;com.MybatisDao&quot;/&gt;</span><br><span class="line">&lt;context:component-scan base-package=&quot;com.MybatisService&quot;/&gt;</span><br><span class="line">&lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span><br><span class="line">      destroy-method=&quot;close&quot;</span><br><span class="line">      p:driverClassName=&quot;$&#123;jdbc.driverClassName&#125;&quot;</span><br><span class="line">      p:url=&quot;$&#123;jdbc.url&#125;&quot;</span><br><span class="line">      p:username=&quot;$&#123;jdbc.username&#125;&quot;</span><br><span class="line">      p:password=&quot;$&#123;jdbc.password&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><br><span class="line">      p:dataSource-ref=&quot;dataSource&quot;</span><br><span class="line">      p:configLocation=&quot;classpath:com/Mybatis/Mybatis.xml&quot;</span><br><span class="line">      p:mapperLocations=&quot;classpath:com/mybatis/*.xml&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用映射接口编写Mybatis的Dao"><a href="#使用映射接口编写Mybatis的Dao" class="headerlink" title="使用映射接口编写Mybatis的Dao"></a>使用映射接口编写Mybatis的Dao</h2><p>下面是Forum,xml文件的映射项定义一个调用接口:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package com.MybatisDao;</span><br><span class="line"></span><br><span class="line">import com.domain.Forum;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface ForumMybatisDao&lt;Forum&gt; extends BaseDao&lt;Forum&gt; &#123;</span><br><span class="line"></span><br><span class="line">     List&lt;Forum&gt; findForumByName(String name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该接口继承至BaseDao:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.MybatisDao;</span><br><span class="line"></span><br><span class="line">import com.domain.Forum;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">public interface BaseDao&lt;T&gt; &#123;</span><br><span class="line">    void save(T entity);</span><br><span class="line">    void update(T entity);</span><br><span class="line">    Forum get(int id);</span><br><span class="line">    void delete(int id);</span><br><span class="line">    int getNum();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Mybatis-spring有一个神奇的转换器:MapperScannerConfigurer,可以将映射接口直接转换为Spring容器中的Bean,这样就可以在Service中注入接口映射的Bean:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span><br><span class="line">          p:sqlSessionFactory-ref=&quot;sqlSessionFactory&quot;</span><br><span class="line">          p:basePackage=&quot;com.MybatisDao&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>MapperScannerConfigurer将扫描basepackage所指定包下的所有接口类(包括子包),如果他们在SQL映射文件中定义过,则动态的为他们生成一个bean,就可以直接在Service中注入接口映射的Bean,如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.MybatisService;</span><br><span class="line"></span><br><span class="line">import com.HibrenateDao.PostHibernateDao;</span><br><span class="line">import com.MybatisDao.ForumMybatisDao;</span><br><span class="line">import com.domain.Forum;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@Service(&quot;forumMybatisService&quot;)</span><br><span class="line">public class ForumMybatisService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ForumMybatisDao forumMybatisDao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void addForum(Forum forum)&#123;</span><br><span class="line">        forumMybatisDao.save(forum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void updateForum(Forum forum)&#123;</span><br><span class="line">        forumMybatisDao.update(forum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public Forum getForum(int id)&#123;</span><br><span class="line">        return forumMybatisDao.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int getForumNum()&#123;</span><br><span class="line">        return forumMybatisDao.getNum();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public List&lt;Forum&gt; findForumByName(String name)&#123;</span><br><span class="line">        return forumMybatisDao.findForumByName(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void deleteForum(int id)&#123;</span><br><span class="line">        forumMybatisDao.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面是测试代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">package com;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import com.MybatisService.ForumMybatisService;</span><br><span class="line">import com.domain.Forum;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.test.annotation.Rollback;</span><br><span class="line">import org.springframework.test.context.ContextConfiguration;</span><br><span class="line">import org.springframework.test.context.testng.AbstractTransactionalTestNGSpringContextTests;</span><br><span class="line">import org.springframework.transaction.annotation.Transactional;</span><br><span class="line">import org.testng.Assert;</span><br><span class="line">import org.testng.annotations.Test;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">@ContextConfiguration(locations = &#123;&quot;classpath:com/Mybatis/applicationContext-mbatis.xml&quot;&#125;)</span><br><span class="line">@Rollback</span><br><span class="line">@Transactional</span><br><span class="line">public class MybatisTest extends AbstractTransactionalTestNGSpringContextTests &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ForumMybatisService forumMybatisService;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testForumMethod() &#123;</span><br><span class="line">        Forum forum = new Forum();</span><br><span class="line">        forum.setForumId(99);</span><br><span class="line">        forum.setForumName(&quot;name_99&quot;);</span><br><span class="line">        forum.setForumDesc(&quot;desc&quot;);</span><br><span class="line">        forumMybatisService.addForum(forum);</span><br><span class="line"></span><br><span class="line">        Forum forum1 = forumMybatisService.getForum(99);</span><br><span class="line">        Assert.assertEquals(&quot;name_99&quot;, forum1.getForumName());</span><br><span class="line">        forum1.setForumName(&quot;forum99&quot;);</span><br><span class="line">        forumMybatisService.updateForum(forum1);</span><br><span class="line"></span><br><span class="line">        forumMybatisService.deleteForum(123);</span><br><span class="line"></span><br><span class="line">        int count=forumMybatisService.getForumNum();</span><br><span class="line"></span><br><span class="line">        List&lt;Forum&gt; forums=new ArrayList&lt;Forum&gt;();</span><br><span class="line">        forums=forumMybatisService.findForumByName(&quot;watermelon&quot;);</span><br><span class="line">        System.out.println(forums);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    <div>
  	
    </div>

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://watermelon-lee.github.io/2018/04/17/Spring-JDBC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="watermelon-lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watermelon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/Spring-JDBC/" itemprop="url">Spring-JDBC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T22:09:29+08:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/study/" itemprop="url" rel="index">
                    <span itemprop="name">study</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/17/Spring-JDBC/" class="leancloud_visitors" data-flag-title="Spring-JDBC">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"> ℃ </span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,235
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  15
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Spring JDBC是Spring所提供的持久层技术.在Spring JDBC里面只需要做那些与业务相关的事情DML操作,而将资源获取,statement创建,资源释放,异常处理的等繁杂的工作交给Spring JDBC.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/17/Spring-JDBC/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    <div>
  	
    </div>

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://watermelon-lee.github.io/2018/04/17/fitness-plan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="watermelon-lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watermelon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/fitness-plan/" itemprop="url">西瓜健身计划</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T14:11:20+08:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/17/fitness-plan/" class="leancloud_visitors" data-flag-title="西瓜健身计划">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"> ℃ </span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1,096
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  4
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>远远去健身房办卡啦,她有点害羞,不知道做什么好,给远远一份健身计划~<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/17/fitness-plan/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    <div>
  	
    </div>

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://watermelon-lee.github.io/2018/04/16/Spring-transaction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="watermelon-lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watermelon">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/16/Spring-transaction/" itemprop="url">Spring事务管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-16T20:42:08+08:00">
                2018-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/study/" itemprop="url" rel="index">
                    <span itemprop="name">study</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/16/Spring-transaction/" class="leancloud_visitors" data-flag-title="Spring事务管理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度&#58;</span>
               
                 <span class="leancloud-visitors-count"> ℃ </span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2,420
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="数据库事务基础知识"><a href="#数据库事务基础知识" class="headerlink" title="数据库事务基础知识"></a>数据库事务基础知识</h1><p>一个数据库事务是一个被视为单一的工作单元的操作序列。这些操作应该要么完整地执行，要么完全不执行。数据库事务必须满足下列四个特性ACID（Atomic，Consistency，Isolation，Durabiliy）：</p>
<ul>
<li>原子性：组成事务的多个数据库操作是一个不可分的原子单元，只有所有的操作成功执行，事务才会提交。</li>
<li>一致性：事务操作成功后，数据库所处的状态是和他的业务规则是一致的，即数据不会被破坏。</li>
<li>隔离性：并发操作数据时，不同的事务拥有各自的空间，他们的操作不会互相干扰。</li>
<li>持久性：一旦事务提交成功后，事务中所有的数据操作都必须持久化到数据库中。
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/04/16/Spring-transaction/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    <div>
  	
    </div>

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="watermelon-lee" />
            
              <p class="site-author-name" itemprop="name">watermelon-lee</p>
              <p class="site-description motion-element" itemprop="description">this is us!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">watermelon-lee</span>

  
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>

-->




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共27.0k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="true"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("", "");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>
